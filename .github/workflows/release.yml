name: Go Build and Release

on:
  push:
    tags:
      - 'v*' # ä»…å½“æ¨é€ä»¥ v å¼€å¤´çš„æ ‡ç­¾ï¼ˆå¦‚ v1.0.1ï¼‰æ—¶è§¦å‘å‘å¸ƒé€»è¾‘
  workflow_dispatch: # ğŸ‘ˆ åŠ å…¥è¿™ä¸€è¡Œï¼Œå…è®¸æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ

jobs:
  build:
    name: Build and Release
    runs-on: ubuntu-latest
    permissions:
      contents: write # èµ‹äºˆ Actions å†™å…¥ Release çš„æƒé™
    strategy:
      matrix:
        include:
          # --- Windows ---
          - goos: windows
            goarch: amd64
          - goos: windows
            goarch: arm64  # é€‚ç”¨äº Surface Pro X ç­‰

          # --- Linux (æœåŠ¡å™¨) ---
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64

          # --- Android (æ‰‹æœºç»ˆç«¯) ---
          - goos: android
            goarch: arm64  # è¿™æ˜¯ä½ æœ€éœ€è¦çš„ï¼Œç”¨äº data/local/tmp è¿è¡Œ

          # --- macOS ---
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64  # M1/M2/M3 èŠ¯ç‰‡

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24.4'
        cache: true

    - name: Build Binary
      run: |
        mkdir -p release
        BINARY_NAME=cf-scanner
        if [ "${{ matrix.goos }}" = "windows" ]; then
          BINARY_NAME=cf-scanner.exe
        fi
        
        # è·å–å½“å‰çš„ Tag åå­—ï¼ˆä¾‹å¦‚ v1.0.1ï¼‰
        TAG_NAME=${GITHUB_REF#refs/tags/}
        
        # æ ¸å¿ƒï¼šä½¿ç”¨ -X æ³¨å…¥å˜é‡å†…å®¹ã€‚æ³¨æ„è¿™é‡Œçš„ main.version å¯¹åº” main åŒ…é‡Œçš„ version å˜é‡
        GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} \
        go build -ldflags "-s -w -X 'main.version=${TAG_NAME}'" \
        -o release/$BINARY_NAME-${{ matrix.goos }}-${{ matrix.goarch }} .

    - name: Create Release and Upload Assets
      uses: softprops/action-gh-release@v1
      with:
        files: release/* # å°†æ‰€æœ‰ç¼–è¯‘äº§ç‰©ä¸Šä¼ åˆ° Release é¡µé¢
        generate_release_notes: true # è‡ªåŠ¨æ ¹æ®æäº¤æ—¥å¿—ç”Ÿæˆç‰ˆæœ¬è¯´æ˜
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}